# Import packages
# -----------------------------------------------------------------------------------------------------------------
import pandas as pd
import psycopg2
from sqlalchemy import create_engine


# -----------------------------------------------------------------------------------------------------------------
# Function to Create a Table from CSV 
# -----------------------------------------------------------------------------------------------------------------
def create_table(file_path,table_name,conn_string):
    # -------------------------------------------------------------------------------------
    pg_conn = psycopg2.connect(conn_string)
    # -------------------------------------------------------------------------------------
    cur     = pg_conn.cursor()
    # -------------------------------------------------------------------------------------
    query   = f"select * from information_schema.tables where table_name='{table_name}'"
    # -------------------------------------------------------------------------------------
    cur.execute(query)
    # -------------------------------------------------------------------------------------
    if not bool(cur.rowcount):
        # -------------------------------------------------------------------------------------
        db   = create_engine(conn_string)
        # -------------------------------------------------------------------------------------
        conn = db.connect()
        # -------------------------------------------------------------------------------------
        df   = pd.read_csv(file_path,nrows=1).head(0)
        # -------------------------------------------------------------------------------------
        df.to_sql(table_name, con=conn, if_exists='replace', index=False)
        # -------------------------------------------------------------------------------------
        print(table_name + " Table Created Successfully")
        # -------------------------------------------------------------------------------------
        cur.close()
        # -------------------------------------------------------------------------------------
    else:
        # -------------------------------------------------------------------------------------
        cur.close()
        # -------------------------------------------------------------------------------------
        print("Table Already Created in Database...")


# -----------------------------------------------------------------------------------------------------------------
# Function to Upload CSV Data to a Table
# -----------------------------------------------------------------------------------------------------------------
def csv_to_table(file_path,table_name,conn_string):
    try:
        # -------------------------------------------------------------------------------------
        query = f"COPY  FROM '{file_path}' DELIMITER ',' CSV HEADER;"
        # -------------------------------------------------------------------------------------
        sql   = query[:5]+table_name+query[5:]        
        # -------------------------------------------------------------------------------------
        pg_conn = psycopg2.connect(conn_string)
        # -------------------------------------------------------------------------------------
        cur = pg_conn.cursor()
        # -------------------------------------------------------------------------------------
        cur.execute(sql)
        # -------------------------------------------------------------------------------------
        pg_conn.commit()
        # -------------------------------------------------------------------------------------
        cur.close()
        # -------------------------------------------------------------------------------------
        print("Successfully Data uploaded to "+table_name )
        # -------------------------------------------------------------------------------------
    except:
        # -------------------------------------------------------------------------------------
        cur.close()
        # -------------------------------------------------------------------------------------
        print("Something went wrong...")



# -----------------------------------------------------------------------------------------------------------------
# Enter Credentials with Database name, host to connect to POSTGRES 
# -----------------------------------------------------------------------------------------------------------------
user        = str(input('Enter User Name     : ')) #'postgres'
password    = str(input('Enter Password      : ')) #'newpassword'
database    = str(input('Enter Database Name : ')) #'superstore'

# -------------------------------------------------------------------------------------
conn_string = 'postgresql://'+user+':'+password+'@localhost/'+database


# -----------------------------------------------------------------------------------------------------------------
# POSTGRES Table Name and CSV File path
# -----------------------------------------------------------------------------------------------------------------
table_name = str(input('Enter Table Name     : ')) #'orders'
file_path  = str(input('Enter File path      : ')) #'Orders.csv'


# -----------------------------------------------------------------------------------------------------------------
# CREATE Table in POSTGRES if Not Exist in Database
# -----------------------------------------------------------------------------------------------------------------
create_table(file_path,table_name,conn_string)


# -----------------------------------------------------------------------------------------------------------------
# Upload CSV Data to Table in POSTGRES
# -----------------------------------------------------------------------------------------------------------------
csv_to_table(file_path,table_name,conn_string)
